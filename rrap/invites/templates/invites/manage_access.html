{% extends "base.html" %}

{% load crispy_forms_filters i18n rrap_invites static %}

{% block title %}{% trans "Manage access" %} Â· {{ organization.title }}{% endblock %}

{% block stylesheet %}
<link rel="stylesheet" type="text/css" href="{% static 'lib/select2/css/select2.min.css' %}" />
<link rel="stylesheet" type="text/css" href="{% static 'lib/jquery.gritter/css/jquery.gritter.css' %}" />
{% endblock %}

{% block javascript %}
<script src="{% static 'lib/select2/js/select2.full.min.js' %}" type="text/javascript"></script>
<script src="{% static 'lib/clipboardjs/clipboard.min.js' %}" type="text/javascript"></script>
<script src="{% static 'lib/jquery.gritter/js/jquery.gritter.js' %}" type="text/javascript"></script>
{% endblock %}

{% block inline_javascript %}
<script type="text/javascript">
  window.addEventListener('DOMContentLoaded', function () {
    var clipboard = new ClipboardJS('.copy');
    clipboard.on('success', function (e) {
      $.extend($.gritter.options, {
        position: 'bottom-right'
      });

      $.gritter.add({
        title: 'Copied',
        text: 'Invitation link to clipboard',
        class_name: 'clean'
      });

      return false;

      // e.clearSelection();
    });

    clipboard.on('error', function (e) {
      console.error('Action:', e.action);
      console.error('Trigger:', e.trigger);
    });
    $(".select2").select2({
      width: '100%',
      placeholder: 'Select username'
    });
  });

</script>
{% endblock %}


{% block content %}

<div class="page-head">
  <nav aria-label="breadcrumb" role="navigation">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <a href="{% url 'core:home' %}">Home</a>
      </li>
      <li class="breadcrumb-item">
        <a href="{% url 'organizations:organizations' %}">Organizations</a>
      </li>
      <li class="breadcrumb-item">
        <a href="% url 'organizations:organization' organization.name %}">{{ organization.title }}</a>
      </li>
      <li class="breadcrumb-item active">
        <a href="#">Invitations</a>
      </li>
    </ol>
  </nav>
  <h2 class="page-head-title">Invite colleagues to collaborate on {{ organization.title }}</h2>
</div>

<div class="main-content container-fluid">
  <div class="row mb-5">
    <div class="col-md-5">
      <div class="card">
        <div class="card-header">Send invitation</div>
        <div class="card-body">
          {% if form.invitee.errors %}
          <ul class="parsley-errors-list filled" id="parsley-invites">
            {% for error in form.invitee.errors %}
            <li class="parsley-required">{{ error }}</li>
            {% endfor %}
          </ul>
          {% elif form.invitee_email.errors %}
          <ul class="parsley-errors-list filled" id="parsley-invites">
            {% for error in form.invitee_email.errors %}
            <li class="parsley-required">{{ error }}</li>
            {% endfor %}
          </ul>
          {% elif form.non_field_errors %}
          <ul class="parsley-errors-list filled" id="parsley-invites">
            {% for error in form.non_field_errors %}
            <li class="parsley-required">{{ error }}</li>
            {% endfor %}
          </ul>
          {% endif %}
          <form action="" method="post">
            {% csrf_token %}
            {{ form|crispy }}
            <button type="submit" class="btn btn-success">{% trans "Send invitation" %}</button>
          </form>
        </div>
      </div>
    </div>
    <div class="col-md-7">
      <div class="card card-table">
        <div class="card-header">Pending invitations</div>
        <div class="card-body">
          <div class="table-responsive noSwipe">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>{% trans "Invitee" %}</th>
                  <th>{% trans "Date sent" %}</th>
                  <th>{% trans "Invited by" %}</th>
                  <th>{% trans "Status" %}</th>
                  <th></th>
                </tr>
              </thead>
              <tbody>
                {% for invite in invites %}
                <tr>
                  <td class="align-middle text-truncate">{{ invite.get_invitee_email }}</td>
                  <td class="align-middle">{{ invite.date_sent|date:"SHORT_DATETIME_FORMAT" }}</td>
                  <td class="align-middle">{{ invite.invited_by.profile.name }}</td>
                  <td class="align-middle">{% invite_status invite %}</td>
                  <td class="align-middle text-right">
                    {% if invite.is_pending %}
                    <div class="btn-group btn-hspace">
                      <button class="btn btn-secondary dropdown-toggle" type="button" data-toggle="dropdown"
                        aria-expanded="false">Action <span class="icon-dropdown mdi mdi-chevron-down"></span></button>
                      <div class="dropdown-menu" role="menu" x-placement="bottom-start"
                        style="position: absolute; will-change: transform; top: 0px; left: 0px; transform: translate3d(0px, 30px, 0px);">
                        <input type="hidden" id="inviteURL" value="{{ invite.full_invitation_url }}" />
                        <a class="dropdown-item copy" data-clipboard-target="#inviteURL">Copy link</a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item"
                          href="{% url 'organizations:invite_delete' organization.name invite.pk %}">Delete
                          invitation</a>
                      </div>
                    </div>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


{% endblock content %}
